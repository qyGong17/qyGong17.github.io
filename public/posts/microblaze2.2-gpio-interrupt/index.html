<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Microblaze2.2 GPIO Interrupt | QY's Notes</title>
<meta name=keywords content="microblaze"><meta name=description content="Hardware Platform
Same hardware platform as in Microblaze2.1 JTAG-UART | QY&rsquo;s Notes
The key_gpio binds to a button on the board.
Configurations
The codes are modified from the interrupt example: xgpio_intr_tapp_example.c. (I found these examples a bit too complicated for a beginner like me.)
Basically:

Initialize the GPIO device
Initialize the interrupt device
Bind the GPIO interrupt handler function
Enable interrupt (both in the GPIO device and the interrupt device)
Wait for the interrupt

Debug
Every time the key is pressed, the LEDs are toggled, and a message is printed through JTAG UART ."><meta name=author content="QY"><link rel=canonical href=qygong17.github.io/posts/microblaze2.2-gpio-interrupt/><meta name=google-site-verification content="qygong17"><meta name=yandex-verification content="qygong17"><meta name=msvalidate.01 content="qygong17"><link crossorigin=anonymous href=qygong17.github.io/assets/css/stylesheet.ba817106d83429143a08d1f1482d38a14bdb99731b9720b4e65c946b0d654e02.css integrity="sha256-uoFxBtg0KRQ6CNHxSC04oUvbmXMblyC05lyUaw1lTgI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=qygong17.github.io/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=/assets/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/assets/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/assets/favicon-32x32.png><link rel=apple-touch-icon href=/assets/apple-touch-icon.png><link rel=mask-icon href=qygong17.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=qygong17.github.io/posts/microblaze2.2-gpio-interrupt/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous referrerpolicy=no-referrer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})})</script><meta property="og:title" content="Microblaze2.2 GPIO Interrupt"><meta property="og:description" content="Hardware Platform
Same hardware platform as in Microblaze2.1 JTAG-UART | QY&rsquo;s Notes
The key_gpio binds to a button on the board.
Configurations
The codes are modified from the interrupt example: xgpio_intr_tapp_example.c. (I found these examples a bit too complicated for a beginner like me.)
Basically:

Initialize the GPIO device
Initialize the interrupt device
Bind the GPIO interrupt handler function
Enable interrupt (both in the GPIO device and the interrupt device)
Wait for the interrupt

Debug
Every time the key is pressed, the LEDs are toggled, and a message is printed through JTAG UART ."><meta property="og:type" content="article"><meta property="og:url" content="qygong17.github.io/posts/microblaze2.2-gpio-interrupt/"><meta property="og:image" content="qygong17.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-26T00:00:00+00:00"><meta property="og:site_name" content="QY's Notes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="qygong17.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Microblaze2.2 GPIO Interrupt"><meta name=twitter:description content="Hardware Platform
Same hardware platform as in Microblaze2.1 JTAG-UART | QY&rsquo;s Notes
The key_gpio binds to a button on the board.
Configurations
The codes are modified from the interrupt example: xgpio_intr_tapp_example.c. (I found these examples a bit too complicated for a beginner like me.)
Basically:

Initialize the GPIO device
Initialize the interrupt device
Bind the GPIO interrupt handler function
Enable interrupt (both in the GPIO device and the interrupt device)
Wait for the interrupt

Debug
Every time the key is pressed, the LEDs are toggled, and a message is printed through JTAG UART ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"qygong17.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Microblaze2.2 GPIO Interrupt","item":"qygong17.github.io/posts/microblaze2.2-gpio-interrupt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Microblaze2.2 GPIO Interrupt","name":"Microblaze2.2 GPIO Interrupt","description":"Hardware Platform Same hardware platform as in Microblaze2.1 JTAG-UART | QY\u0026rsquo;s Notes\nThe key_gpio binds to a button on the board.\nConfigurations The codes are modified from the interrupt example: xgpio_intr_tapp_example.c. (I found these examples a bit too complicated for a beginner like me.)\nBasically:\nInitialize the GPIO device Initialize the interrupt device Bind the GPIO interrupt handler function Enable interrupt (both in the GPIO device and the interrupt device) Wait for the interrupt Debug Every time the key is pressed, the LEDs are toggled, and a message is printed through JTAG UART .\n","keywords":["microblaze"],"articleBody":"Hardware Platform Same hardware platform as in Microblaze2.1 JTAG-UART | QYâ€™s Notes\nThe key_gpio binds to a button on the board.\nConfigurations The codes are modified from the interrupt example: xgpio_intr_tapp_example.c. (I found these examples a bit too complicated for a beginner like me.)\nBasically:\nInitialize the GPIO device Initialize the interrupt device Bind the GPIO interrupt handler function Enable interrupt (both in the GPIO device and the interrupt device) Wait for the interrupt Debug Every time the key is pressed, the LEDs are toggled, and a message is printed through JTAG UART .\nSample Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 #include #include \"platform.h\" #include \"xil_printf.h\" #include \"xgpio.h\" #include \"xintc.h\" #include \"xil_exception.h\" // use two GPIO modules, both with only channel 1 #define GPIO_CHANNEL1 1 #define DIR_OUTPUT 0 #define DIR_INPUT 0x0001 #define INTC_DELAY 2000000 // the width of key_gpio is 1, // so only the first bit is used. #define KEY_GPIO_BIT 0x0001 void gpio_handler(void *CallBackRef); void init_gpio(); void init_gpio_intr(); int Led_on; int IntrCnt; XGpio led_gpio; XGpio key_gpio; XIntc intc; int main() { init_platform(); init_gpio(); // initialize key and led gpio init_gpio_intr(); // initialize interrupt Led_on = 0; IntrCnt = 0; print(\"Receiving key interrupts.\\n\\r\"); while(1){ } //cleanup_platform(); return 0; } void init_gpio() { int status; // XPAR_GPIO_LED_DEVICE_ID: see xparameters.h // initialize led_gpio as all output status = XGpio_Initialize(\u0026led_gpio, XPAR_GPIO_LED_DEVICE_ID); if(status != XST_SUCCESS) //if status!=0 { printf(\"Gpio LED Initialization Failed\\r\\n\"); return XST_FAILURE; //return 1 } XGpio_SetDataDirection(\u0026led_gpio, GPIO_CHANNEL1, DIR_OUTPUT); //all bits as output //initialize key_gpio as input status = XGpio_Initialize(\u0026key_gpio, XPAR_GPIO_KEY_DEVICE_ID); if(status != XST_SUCCESS) //if status!=0 { printf(\"Gpio KEY Initialization Failed\\r\\n\"); return XST_FAILURE; //return 1 } XGpio_SetDataDirection(\u0026key_gpio, GPIO_CHANNEL1, DIR_INPUT); //set the last bit as input } void init_gpio_intr() { int status; //initialize the interrupt controller, intc status = XIntc_Initialize(\u0026intc, XPAR_MICROBLAZE_0_AXI_INTC_DEVICE_ID); if(status != XST_SUCCESS) //if status!=0 { printf(\"INTC Initialization Failed\\r\\n\"); return XST_FAILURE; //return 1 } /* Hook up interrupt service routine */ XIntc_Connect(\u0026intc, XPAR_INTC_0_GPIO_0_VEC_ID, (Xil_ExceptionHandler)gpio_handler, \u0026key_gpio); /* Enable the interrupt vector at the interrupt controller */ XIntc_Enable(\u0026intc, XPAR_INTC_0_GPIO_0_VEC_ID); /* * Start the interrupt controller such that interrupts are recognized * and handled by the processor */ status = XIntc_Start(\u0026intc, XIN_REAL_MODE); if (status != XST_SUCCESS) { printf(\"INTC start Failed\\r\\n\"); return XST_FAILURE; //return 1 } //enable GPIO interrupt for the first bit in key_gpio XGpio_InterruptEnable(\u0026key_gpio, KEY_GPIO_BIT); XGpio_InterruptGlobalEnable(\u0026key_gpio); /* * Initialize the exception table and register the interrupt * controller handler with the exception table */ Xil_ExceptionInit(); Xil_ExceptionRegisterHandler(XIL_EXCEPTION_ID_INT, (Xil_ExceptionHandler)XIntc_InterruptHandler, \u0026intc); /* Enable non-critical exceptions */ Xil_ExceptionEnable(); } void gpio_handler(void *CallBackRef) { XGpio *GpioPtr = (XGpio *)CallBackRef; int delay; IntrCnt ++; // disable the gpio interrupt for a while // a very simple key debounce XGpio_InterruptDisable(\u0026key_gpio, KEY_GPIO_BIT); for(delay=0;delay \u003c INTC_DELAY; delay++); //introduce some delay XGpio_InterruptEnable(\u0026key_gpio, KEY_GPIO_BIT); // toggle the LEDs every time gpio interrupt is triggered if(Led_on) { Led_on = 0; //GPIO output 0 XGpio_DiscreteWrite(\u0026led_gpio, GPIO_CHANNEL1, 0x00); } else { Led_on = 1; //GPIO output 1 XGpio_DiscreteWrite(\u0026led_gpio, GPIO_CHANNEL1, 0x0F); } //should use xil_printf() instead of print() xil_printf(\"Key pressed count: %d.\\n\\r\", IntrCnt); /* Clear the Interrupt */ XGpio_InterruptClear(GpioPtr, KEY_GPIO_BIT); } ","wordCount":"641","inLanguage":"en","datePublished":"2023-05-26T00:00:00Z","dateModified":"2023-05-26T00:00:00Z","author":{"@type":"Person","name":"QY"},"mainEntityOfPage":{"@type":"WebPage","@id":"qygong17.github.io/posts/microblaze2.2-gpio-interrupt/"},"publisher":{"@type":"Organization","name":"QY's Notes","logo":{"@type":"ImageObject","url":"/assets/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=qygong17.github.io/ accesskey=h title="QY's Notes (Alt + H)">QY's Notes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=qygong17.github.io/qygong17.github.io/about/ title=About><span>About</span></a></li><li><a href=qygong17.github.io/qygong17.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=qygong17.github.io/qygong17.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=qygong17.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=qygong17.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=qygong17.github.io/posts/>Posts</a></div><h1 class=post-title>Microblaze2.2 GPIO Interrupt</h1><div class=post-meta>&lt;span title='2023-05-26 00:00:00 +0000 UTC'>May 26, 2023&lt;/span>&amp;nbsp;Â·&amp;nbsp;QY&amp;nbsp;Â·&amp;nbsp;&lt;a href="/tags/microblaze"> microblaze&lt;/a>&nbsp;|&nbsp;<a href=https://github.com/qyGong17/qyGong17.github.io/tree/main/content/posts/Microblaze2.2%20GPIO%20Interrupt.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#hardware-platform aria-label="Hardware Platform">Hardware Platform</a></li><li><a href=#configurations aria-label=Configurations>Configurations</a></li><li><a href=#debug aria-label=Debug>Debug</a></li><li><a href=#sample-code aria-label="Sample Code">Sample Code</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=hardware-platform>Hardware Platform<a hidden class=anchor aria-hidden=true href=#hardware-platform>#</a></h1><p>Same hardware platform as in <a href=https://qygong17.github.io/posts/microblaze2.1-jtag-uart/>Microblaze2.1 JTAG-UART | QY&rsquo;s Notes</a></p><p>The <code>key_gpio</code> binds to a button on the board.</p><h1 id=configurations>Configurations<a hidden class=anchor aria-hidden=true href=#configurations>#</a></h1><p>The codes are modified from the interrupt example: <code>xgpio_intr_tapp_example.c</code>. (I found these examples a bit too complicated for a beginner like me.)</p><p>Basically:</p><ul><li>Initialize the <code>GPIO device</code></li><li>Initialize the <code>interrupt device</code></li><li>Bind the GPIO interrupt handler function</li><li>Enable interrupt (both in the GPIO device and the interrupt device)</li><li>Wait for the interrupt</li></ul><h1 id=debug>Debug<a hidden class=anchor aria-hidden=true href=#debug>#</a></h1><p>Every time the key is pressed, the LEDs are toggled, and a message is printed through <code>JTAG UART</code> .</p><p><img loading=lazy src=/images/img_2023-05-26.png alt></p><h1 id=sample-code>Sample Code<a hidden class=anchor aria-hidden=true href=#sample-code>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;platform.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;xil_printf.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;xgpio.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;xintc.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;xil_exception.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// use two GPIO modules, both with only channel 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define GPIO_CHANNEL1 1
</span></span></span><span class=line><span class=cl><span class=cp>#define DIR_OUTPUT 	0
</span></span></span><span class=line><span class=cl><span class=cp>#define DIR_INPUT 	0x0001
</span></span></span><span class=line><span class=cl><span class=cp>#define INTC_DELAY 2000000
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// the width of key_gpio is 1,
</span></span></span><span class=line><span class=cl><span class=c1>// so only the first bit is used.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define KEY_GPIO_BIT 0x0001
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>gpio_handler</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>CallBackRef</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>init_gpio</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>init_gpio_intr</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>Led_on</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>IntrCnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>XGpio</span> <span class=n>led_gpio</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>XGpio</span> <span class=n>key_gpio</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>XIntc</span> <span class=n>intc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>init_platform</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>init_gpio</span><span class=p>();</span> <span class=c1>// initialize key and led gpio
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>init_gpio_intr</span><span class=p>();</span> <span class=c1>// initialize interrupt
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>Led_on</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>IntrCnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>print</span><span class=p>(</span><span class=s>&#34;Receiving key interrupts.</span><span class=se>\n\r</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//cleanup_platform();
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>init_gpio</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// XPAR_GPIO_LED_DEVICE_ID: see xparameters.h
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// initialize led_gpio as all output
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>status</span> <span class=o>=</span> <span class=nf>XGpio_Initialize</span><span class=p>(</span><span class=o>&amp;</span><span class=n>led_gpio</span><span class=p>,</span> <span class=n>XPAR_GPIO_LED_DEVICE_ID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>XST_SUCCESS</span><span class=p>)</span> <span class=c1>//if status!=0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Gpio LED Initialization Failed</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>XST_FAILURE</span><span class=p>;</span> <span class=c1>//return 1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>XGpio_SetDataDirection</span><span class=p>(</span><span class=o>&amp;</span><span class=n>led_gpio</span><span class=p>,</span> <span class=n>GPIO_CHANNEL1</span><span class=p>,</span> <span class=n>DIR_OUTPUT</span><span class=p>);</span> <span class=c1>//all bits as output
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>//initialize key_gpio as input
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>status</span> <span class=o>=</span> <span class=nf>XGpio_Initialize</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>,</span> <span class=n>XPAR_GPIO_KEY_DEVICE_ID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>XST_SUCCESS</span><span class=p>)</span> <span class=c1>//if status!=0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Gpio KEY Initialization Failed</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>XST_FAILURE</span><span class=p>;</span> <span class=c1>//return 1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>XGpio_SetDataDirection</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>,</span> <span class=n>GPIO_CHANNEL1</span><span class=p>,</span> <span class=n>DIR_INPUT</span><span class=p>);</span> <span class=c1>//set the last bit as input
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>init_gpio_intr</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//initialize the interrupt controller, intc
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>status</span> <span class=o>=</span> <span class=nf>XIntc_Initialize</span><span class=p>(</span><span class=o>&amp;</span><span class=n>intc</span><span class=p>,</span> <span class=n>XPAR_MICROBLAZE_0_AXI_INTC_DEVICE_ID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>XST_SUCCESS</span><span class=p>)</span> <span class=c1>//if status!=0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;INTC Initialization Failed</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>XST_FAILURE</span><span class=p>;</span> <span class=c1>//return 1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Hook up interrupt service routine */</span>
</span></span><span class=line><span class=cl>	<span class=nf>XIntc_Connect</span><span class=p>(</span><span class=o>&amp;</span><span class=n>intc</span><span class=p>,</span> <span class=n>XPAR_INTC_0_GPIO_0_VEC_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		      <span class=p>(</span><span class=n>Xil_ExceptionHandler</span><span class=p>)</span><span class=n>gpio_handler</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Enable the interrupt vector at the interrupt controller */</span>
</span></span><span class=line><span class=cl>	<span class=nf>XIntc_Enable</span><span class=p>(</span><span class=o>&amp;</span><span class=n>intc</span><span class=p>,</span> <span class=n>XPAR_INTC_0_GPIO_0_VEC_ID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Start the interrupt controller such that interrupts are recognized
</span></span></span><span class=line><span class=cl><span class=cm>	 * and handled by the processor
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=n>status</span> <span class=o>=</span> <span class=nf>XIntc_Start</span><span class=p>(</span><span class=o>&amp;</span><span class=n>intc</span><span class=p>,</span> <span class=n>XIN_REAL_MODE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>XST_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;INTC start Failed</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>XST_FAILURE</span><span class=p>;</span> <span class=c1>//return 1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//enable GPIO interrupt for the first bit in key_gpio
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>XGpio_InterruptEnable</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>,</span> <span class=n>KEY_GPIO_BIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>XGpio_InterruptGlobalEnable</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Initialize the exception table and register the interrupt
</span></span></span><span class=line><span class=cl><span class=cm>	 * controller handler with the exception table
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>Xil_ExceptionInit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>Xil_ExceptionRegisterHandler</span><span class=p>(</span><span class=n>XIL_EXCEPTION_ID_INT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			 <span class=p>(</span><span class=n>Xil_ExceptionHandler</span><span class=p>)</span><span class=n>XIntc_InterruptHandler</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>intc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Enable non-critical exceptions */</span>
</span></span><span class=line><span class=cl>	<span class=nf>Xil_ExceptionEnable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>gpio_handler</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>CallBackRef</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>XGpio</span> <span class=o>*</span><span class=n>GpioPtr</span> <span class=o>=</span> <span class=p>(</span><span class=n>XGpio</span> <span class=o>*</span><span class=p>)</span><span class=n>CallBackRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>delay</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>IntrCnt</span> <span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// disable the gpio interrupt for a while
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a very simple key debounce
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>XGpio_InterruptDisable</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>,</span> <span class=n>KEY_GPIO_BIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=n>delay</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>delay</span> <span class=o>&lt;</span> <span class=n>INTC_DELAY</span><span class=p>;</span> <span class=n>delay</span><span class=o>++</span><span class=p>);</span> <span class=c1>//introduce some delay
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>XGpio_InterruptEnable</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key_gpio</span><span class=p>,</span> <span class=n>KEY_GPIO_BIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// toggle the LEDs every time gpio interrupt is triggered
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>Led_on</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Led_on</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=c1>//GPIO output 0
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>XGpio_DiscreteWrite</span><span class=p>(</span><span class=o>&amp;</span><span class=n>led_gpio</span><span class=p>,</span> <span class=n>GPIO_CHANNEL1</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Led_on</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=c1>//GPIO output 1
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>XGpio_DiscreteWrite</span><span class=p>(</span><span class=o>&amp;</span><span class=n>led_gpio</span><span class=p>,</span> <span class=n>GPIO_CHANNEL1</span><span class=p>,</span> <span class=mh>0x0F</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//should use xil_printf() instead of print()
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>xil_printf</span><span class=p>(</span><span class=s>&#34;Key pressed count: %d.</span><span class=se>\n\r</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>IntrCnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Clear the Interrupt */</span>
</span></span><span class=line><span class=cl>	<span class=nf>XGpio_InterruptClear</span><span class=p>(</span><span class=n>GpioPtr</span><span class=p>,</span> <span class=n>KEY_GPIO_BIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=qygong17.github.io/tags/microblaze/>Microblaze</a></li></ul><nav class=paginav><a class=prev href=qygong17.github.io/posts/microblaze3-i2c-eeprom-polled/><span class=title>Â« Prev</span><br><span>Microblaze3 I2C EEPROM Polled</span>
</a><a class=next href=qygong17.github.io/posts/microblaze2.1-jtag-uart/><span class=title>Next Â»</span><br><span>Microblaze2.1 JTAG-UART</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=qygong17.github.io/>QY's Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>